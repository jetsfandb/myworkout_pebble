<!DOCTYPE html>
<html>
<head>
  <title>Workout Config</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    h2 { margin: 10px 0; }
    input[type="text"], input[type="number"] { width: 100%; box-sizing: border-box; }
    .form-row { margin-bottom: 10px; }
    .exercise-item, .setting-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .exercise-actions, .setting-actions { text-align: right; }
    .delete-btn { color: red; }
    .settings-list { padding-left: 20px; }
  </style>
</head>
<body>
  <h1>Workout Config</h1>

  <form id="configForm">
    <div class="form-row">
      <label for="workoutName">Workout Name:</label>
      <input type="text" id="workoutName" placeholder="Enter workout name">
      <label for="workoutRest">Workout Rest (seconds):</label>
      <input type="number" id="workoutRest" placeholder="Enter workout rest">
    </div>

    <div id="exerciseList"></div>
    <button type="button" id="addExerciseBtn">Add Exercise</button>

    <div class="form-row">
      <button type="submit">Save</button>
    </div>
  </form>

  <script>
    const saveSettingsEvent = new CustomEvent('savessettings', {
       detail: {
         message: 'Settings saved'
        },
        bubbles: true,
        cancelable: false
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load and apply settings from localStorage
      var config = JSON.parse(localStorage.getItem('workoutConfig')) || {
        workoutName: '',
        workoutRest: 0,
        exercises: []
      };
      
      var form = document.getElementById('configForm');
      var exerciseList = document.getElementById('exerciseList');

      document.getElementById('workoutName').value = config.workoutName;

      // Function to render the full exercise list
      function renderExercises() {
        exerciseList.innerHTML = '';
        config.exercises.forEach(function(exercise, exerciseIndex) {
          var exerciseItem = document.createElement('div');
          exerciseItem.className = 'exercise-item';
          exerciseItem.innerHTML = `
            <h2>Exercise ${exerciseIndex + 1}</h2>
            <div class="form-row">
              <label>Title:</label>
              <input type="text" data-field="title" value="${exercise.title}">
            </div>
            <div class="form-row">
              <label>Weight:</label>
              <input type="number" data-field="weight" value="${exercise.weight}">
            </div>
            <div class="form-row">
              <label>Count:</label>
              <input type="number" data-field="count" value="${exercise.count}">
            </div>
            <h3>Settings</h3>
            <div class="settings-list" data-exercise-index="${exerciseIndex}"></div>
            <button type="button" class="add-setting-btn" data-exercise-index="${exerciseIndex}">Add Setting</button>
            <div class="exercise-actions">
              <button type="button" class="delete-btn" data-exercise-index="${exerciseIndex}">Delete Exercise</button>
            </div>
          `;
          exerciseList.appendChild(exerciseItem);

          var settingsList = exerciseItem.querySelector('.settings-list');
          exercise.settings.forEach(function(setting, settingIndex) {
            var settingItem = document.createElement('div');
            settingItem.className = 'setting-item';
            settingItem.innerHTML = `
              <div class="form-row">
                <label>Title:</label>
                <input type="text" data-field="title" value="${setting.title}">
              </div>
              <div class="form-row">
                <label>Value:</label>
                <input type="number" data-field="value" value="${setting.value}">
              </div>
              <div class="setting-actions">
                <button type="button" class="delete-setting-btn" data-exercise-index="${exerciseIndex}" data-setting-index="${settingIndex}">Delete Setting</button>
              </div>
            `;
            settingsList.appendChild(settingItem);
          });
        });
      }

      // Add a new exercise
      document.getElementById('addExerciseBtn').addEventListener('click', function() {
        config.exercises.push({
          title: '',
          weight: 0,
          count: 0,
          settings: []
        });
        renderExercises();
      });

      // Handle events for dynamically created elements
      exerciseList.addEventListener('click', function(event) {
        // Delete exercise
        if (event.target.classList.contains('delete-btn')) {
          var index = parseInt(event.target.dataset.exerciseIndex);
          config.exercises.splice(index, 1);
          renderExercises();
        }
        // Add setting
        if (event.target.classList.contains('add-setting-btn')) {
          var index = parseInt(event.target.dataset.exerciseIndex);
          config.exercises[index].settings.push({ title: '', value: 0 });
          renderExercises();
        }
        // Delete setting
        if (event.target.classList.contains('delete-setting-btn')) {
          var exerciseIndex = parseInt(event.target.dataset.exerciseIndex);
          var settingIndex = parseInt(event.target.dataset.settingIndex);
          config.exercises[exerciseIndex].settings.splice(settingIndex, 1);
          renderExercises();
        }
      });
      
      // Update config object on input change
      exerciseList.addEventListener('input', function(event) {
        var input = event.target;
        var exerciseItem = input.closest('.exercise-item');
        var settingItem = input.closest('.setting-item');
        
        if (settingItem) {
          // Update setting value
          var exerciseIndex = parseInt(settingItem.closest('.settings-list').dataset.exerciseIndex);
          var settingIndex = Array.from(settingItem.parentNode.children).indexOf(settingItem);
          var field = input.dataset.field;
          var value = (field === 'value') ? parseInt(input.value) : input.value;
          config.exercises[exerciseIndex].settings[settingIndex][field] = value;
        } else if (exerciseItem) {
          // Update exercise value
          var exerciseIndex = Array.from(exerciseList.children).indexOf(exerciseItem);
          var field = input.dataset.field;
          var value = (field === 'weight' || field === 'count') ? parseInt(input.value) : input.value;
          config.exercises[exerciseIndex][field] = value;
        }
      });
      
      document.getElementById('workoutName').addEventListener('input', function(event) {
        config.workoutName = event.target.value;
      });

      document.getElementById('workoutRest').addEventListener('input', function(event) {
        config.workoutRest = parseInt(event.target.value) || 0;
      });
      
      // Handle form submission
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Save the updated configuration to localStorage
        localStorage.setItem('workoutConfig', JSON.stringify(config));

        // Get the return_to URL parameter for CloudPebble
        var returnTo = getQueryParam('return_to');
        if (returnTo) {
          // For CloudPebble: send data back via URL
          document.location.href = returnTo + '#appcfg=' + encodeURIComponent(JSON.stringify(config));
        } else {
          // For native SDK: let index.js handle the closing logic
          // The data is saved to localStorage for index.js to pick up
          window.dispatchEvent(saveSettingsEvent);
          window.close();
        }
      });

      function getQueryParam(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      renderExercises();
    });
  </script>
</body>
</html>
